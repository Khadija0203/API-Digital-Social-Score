steps:
  # Etape 0: Configuration Cloud Storage et outils
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "üîß Configuration Cloud Storage pour MLOps..."
        # Cr√©ation du bucket pour les mod√®les
        gsutil mb -p $PROJECT_ID gs://mlops-models-$PROJECT_ID || true
        # Cr√©ation du bucket pour les donn√©es
        gsutil mb -p $PROJECT_ID gs://mlops-data-$PROJECT_ID || true

        # Installation d'envsubst pour substitution de variables
        apt-get update && apt-get install -y gettext-base

        echo "‚úÖ Cloud Storage et outils configur√©s"

  # Etape 1: Tests unitaires
  - name: python:3.11
    entrypoint: bash
    args:
      - -c
      - |
        pip install -r requirements.txt
        pytest Tests/ || echo "Tests √©chou√©s mais pipeline continue"

  # Etape 2: MLflow + Vertex AI
  - name: python:3.11
    entrypoint: bash
    args:
      - -c
      - |
        pip install -r requirements.txt

        # Configuration MLflow
        export MLFLOW_TRACKING_URI="gs://mlops-models-$PROJECT_ID/mlflow"

        # Verification si entrainement necessaire - UNIQUEMENT main
        if [[ "$BRANCH_NAME" == "main" ]] || [[ "$BRANCH_NAME" == "master" ]]; then
          echo "Declenchement Vertex AI pour branche principale: $BRANCH_NAME"
          
          # Configuration des variables d'environnement
          export PROJECT_ID=$PROJECT_ID
          export REGION="europe-west1"
          
          # Entrainement UNIQUEMENT sur Vertex AI
          echo "Lancement pipeline Vertex AI"
          export VERTEX_MODE=integrated
          python vertex.py
          
          echo "Entrainement termine"
        else
          echo "Entrainement ignore pour branche: $BRANCH_NAME"
        fi

  # Etape 3: Vertex AI Pipeline
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: bash
    args:
      - -c
      - |
        if [[ "$_ENABLE_VERTEX_AI" == "true" ]]; then
          echo "Activation Pipeline Vertex AI"
          
          # Installation des dependances Vertex AI
          pip install google-cloud-aiplatform kfp
          
          # Configuration Vertex AI
          export PROJECT_ID=$PROJECT_ID
          export REGION=${_VERTEX_REGION:-europe-west1}
          
          # Execution du pipeline Vertex AI
          echo "Lancement pipeline Vertex AI distribue..."
          python vertex.py
          
          echo "Pipeline Vertex AI complete"
        else
          echo "Pipeline Vertex AI desactive (utilisez _ENABLE_VERTEX_AI=true)"
        fi

  # Etape 4: Construction de l'image Docker
  - name: "gcr.io/cloud-builders/docker"
    args:
      ["build", "-t", "gcr.io/$PROJECT_ID/toxic-detection-api:$COMMIT_SHA", "."]

  # Etape 5: Push vers Container Registry
  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/toxic-detection-api:$COMMIT_SHA"]

  # Etape 6: Creation automatique du cluster GKE
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: bash
    args:
      - -c
      - |
        if [[ "$_DEPLOY_TO_GKE" == "true" ]]; then
          echo "üöÄ D√©ploiement GKE MLOps activ√©"
          
          # V√©rifier si le cluster existe
          if gcloud container clusters describe ${_CLUSTER_NAME} --zone ${_CLUSTER_ZONE} --project $PROJECT_ID > /dev/null 2>&1; then
            echo "‚úÖ Cluster existant trouv√©: ${_CLUSTER_NAME}"
          else
            echo "üîß Cr√©ation automatique du cluster GKE..."
            gcloud container clusters create ${_CLUSTER_NAME} \
              --zone ${_CLUSTER_ZONE} \
              --project $PROJECT_ID \
              --machine-type e2-standard-2 \
              --num-nodes 2 \
              --enable-autoscaling \
              --min-nodes 1 \
              --max-nodes 4 \
              --enable-autorepair \
              --enable-autoupgrade \
              --disk-size 50GB \
              --labels="environment=mlops,app=toxic-detection" \
              --tags="mlops,api" \
              --enable-cloud-logging \
              --enable-cloud-monitoring \
              --addons=HttpLoadBalancing,HorizontalPodAutoscaling \
              --no-enable-basic-auth \
              --enable-ip-alias
            
            echo "‚úÖ Cluster cr√©√© avec succ√®s"
          fi
          
          # Configuration kubectl
          echo "üîó Configuration kubectl..."
          gcloud container clusters get-credentials ${_CLUSTER_NAME} --zone ${_CLUSTER_ZONE} --project $PROJECT_ID
          
          # Appliquer le d√©ploiement avec substitution des variables
          echo "üì¶ D√©ploiement de l'application..."
          envsubst < k8s/deployment.yaml | kubectl apply -f -
          
          # Mise √† jour de l'image Docker
          echo "üîÑ Mise √† jour de l'image: gcr.io/$PROJECT_ID/toxic-detection-api:$COMMIT_SHA"
          kubectl set image deployment/toxic-detection-api api=gcr.io/$PROJECT_ID/toxic-detection-api:$COMMIT_SHA
          
          # Attendre le d√©ploiement
          echo "‚è≥ Attente du d√©ploiement..."
          kubectl rollout status deployment/toxic-detection-api --timeout=600s
          
          # Obtenir l'IP externe
          echo "üåê R√©cup√©ration de l'IP externe..."
          kubectl get service toxic-detection-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}' > /tmp/external_ip
          EXTERNAL_IP=$$(cat /tmp/external_ip)
          echo "üéØ API accessible sur: http://$$EXTERNAL_IP"
          echo "üìä Health check: http://$$EXTERNAL_IP/health"
          echo "üìñ Documentation: http://$$EXTERNAL_IP/docs"
          
        else
          echo "‚ö†Ô∏è D√©ploiement GKE d√©sactiv√© (utilisez _DEPLOY_TO_GKE=true)"
          echo "üì¶ Image Docker cr√©√©e: gcr.io/$PROJECT_ID/toxic-detection-api:$COMMIT_SHA"
        fi

images:
  - "gcr.io/$PROJECT_ID/toxic-detection-api:$COMMIT_SHA"

# Variables de substitution pour personaliser le comportement
substitutions:
  _USE_VERTEX_COMPUTE: "true" # "true" = Vertex AI compute + MLflow tracking
  _TRAINING_SCALE: "quick" # "quick", "standard", "large"
  _ENABLE_VERTEX_AI: "true" # "true" pour pipelines avanc√©s Vertex AI
  _VERTEX_REGION: "europe-west1" # Region pour Vertex AI
  _DEPLOY_TO_GKE: "true" # "true" pour activer deployment GKE automatique
  _CLUSTER_NAME: "mlops-toxic-detection-cluster" # Nom du nouveau cluster MLOps
  _CLUSTER_ZONE: "europe-west1-b" # Zone europ√©enne pour conformit√© RGPD

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: "E2_HIGHCPU_8" # Plus de CPU pour ML
  substitution_option: "ALLOW_LOOSE"
