options:
  logging: CLOUD_LOGGING_ONLY

steps:
# === √âtape 1 : Tests unitaires ===
- name: 'python:3.11'
  entrypoint: bash
  args:
    - -c
    - |
      pip install -r requirements.txt
      echo "üß™ D√©but des tests unitaires..."
      pytest || echo "‚ö†Ô∏è Aucun test trouv√© ou tests ignor√©s"

# === √âtape 2 : Build de l‚Äôimage Docker ===
- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'build'
    - '-t'
    - 'gcr.io/simplifia-hackathon/toxic-detection-api:$COMMIT_SHA'
    - '.'

# === √âtape 3 : Push de l‚Äôimage sur Google Container Registry ===
- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'push'
    - 'gcr.io/simplifia-hackathon/toxic-detection-api:$COMMIT_SHA'

# === √âtape 4 : D√©ploiement automatique sur Kubernetes (GKE) ===
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: bash
  args:
    - -c
    - |
      echo "‚öôÔ∏è Configuration de kubectl..."
      gcloud container clusters get-credentials deployment-toxic-exo-cluster --region us-central1 --project simplifia-hackathon
      echo "üöÄ D√©ploiement de la nouvelle image sur GKE..."
      kubectl set image deployment/deployment-toxic-exo toxic-detection-api-1=gcr.io/simplifia-hackathon/toxic-detection-api:$COMMIT_SHA
      kubectl rollout status deployment/deployment-toxic-exo

# === √âtape 5 : Lancer le pipeline Vertex AI ===
- name: 'python:3.11'
  entrypoint: bash
  args:
    - -c
    - |
      pip install google-cloud-aiplatform
      echo "üéØ Lancement du pipeline Vertex AI..."
      python trigger_pipeline.py

images:
  - 'gcr.io/simplifia-hackathon/toxic-detection-api:$COMMIT_SHA'
